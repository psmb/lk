var exaportViewEdit,newItem=null,lastclicked=null;define(["jquery","block_exaport/jquery.json","jqueryui","core/modal_factory","core/modal_events"],function(e,t,i,a,d){function n(){e(".portfolioOptions li").removeClass("selected"),e(".portfolioDesignBlocks > li").each(function(){e(".portfolioOptions li[itemid="+e(this).data("portfolio").itemid+"]").addClass("selected")})}function s(){var t=[];e(".portfolioDesignBlocks").each(function(i){e(this).children("li:visible").not(".block-placeholder").each(function(a){t.push(e.extend(e(this).data("portfolio"),{positionx:i+1,positiony:a+1}))})});var i=e("form :input[name=blocks]");i.val(e.toJSON(t))}function l(t,i){var a;"new"==t?(a=e("<li></li>"),a.data("portfolio",i)):(a=e(i),i=a.data("portfolio"),i||(i={},a.attr("itemid")?(i.type="item",i.itemid=a.attr("itemid")):(i.type=a.attr("block-type"),a.attr("text")&&(i.text=a.attr("text")),a.attr("block_title")&&(i.block_title=a.attr("block_title")),a.attr("firstname")&&(i.firstname=a.attr("firstname")),a.attr("lastname")&&(i.lastname=a.attr("lastname")),a.attr("picture")&&(i.picture=a.attr("picture")),a.attr("email")&&(i.email=a.attr("email"))),a.data("portfolio",i))),a.addClass("item"),a.css("position","relative");if(i.itemid&&!i.item&&portfolioItems&&portfolioItems[i.itemid]&&(i.item=portfolioItems[i.itemid]),"item"==i.type&&i.itemid&&i.item){var d=i.item,n=d.link;""!=n&&(n=$E.translate("link")+": "+n+"<br />"),d.competences?a.html('<div id="id_holder" style="display:none;"></div><div class="item_info" style="overflow: hidden;"><div class="header">'+$E.translate("viewitem")+": "+d.name+'</div><div class="picture" style="float:right; position: relative; height: 100px; width: 100px;"><img style="max-width: 100%; max-height: 100%;" src="'+M.cfg.wwwroot+"/blocks/exaport/item_thumb.php?item_id="+d.id+'"></div><div class="body">'+$E.translate("type")+": "+$E.translate(d.type)+"<br />"+$E.translate("category")+": "+d.category+"<br />"+n+$E.translate("comments")+": "+d.comments+'<div class="exaport-item-intro"></div><script type="text/javascript" src="javascript/wz_tooltip.js"></script><a onmouseover="Tip(\''+d.competences+'\')" onmouseout="UnTip()"><img src="'+M.cfg.wwwroot+'/pix/t/grades.png" class="iconsmall" alt="competences" /></a></div></div>'):(a.html('<div id="id_holder" style="display:none;"></div><div class="item_info" style="overflow: hidden;"><div class="header">'+$E.translate("viewitem")+": "+d.name+'</div><div class="picture" style="float:right; position: relative; height: 100px; width: 100px;"><img style="max-width: 100%; max-height: 100%;" src="'+M.cfg.wwwroot+"/blocks/exaport/item_thumb.php?item_id="+d.id+'"></div><div class="body">'+$E.translate("type")+": "+$E.translate(d.type)+"<br />"+$E.translate("category")+": "+d.category+"<br />"+n+$E.translate("comments")+": "+d.comments+'<div class="exaport-item-intro"></div></div></div>'),a.find(".exaport-item-intro").html(d.intro))}else if("personal_information"==i.type)a.html('<div id="id_holder" style="display:none;"></div><div class="personal_info" style="overflow: hidden;"><div class="header">'+$E.translate("personalinformation")+': </div><div class="picture" style="float:right; position: relative;"></div><div class="name"></div><div class="email"></div><div class="body"></div></div>'),a.find("div.header").append(i.block_title),""!=i.picture&&null!=i.picture&&a.find("div.picture").append('<img src="'+i.picture+'">'),a.find("div.name").append(i.firstname),a.find("div.name").append(" "),a.find("div.name").append(i.lastname),a.find("div.email").append(i.email),a.find("div.body").append(i.print_text);else if("headline"==i.type)a.html('<div id="id_holder" style="display:none;"></div><div class="header">'+$E.translate("view_specialitem_headline")+'<div class="body"></div></div>'),a.find("div.body").append(i.print_text);else if("media"==i.type)a.html('<div id="id_holder" style="display:none;"></div><div class="header"></div><div class="body"></div>'),a.find("div.header").append($E.translate("view_specialitem_media")+(e.trim(i.block_title).length?": "+i.block_title:"")),a.find("div.body").append(i.contentmedia);else if("badge"==i.type)if("undefined"==typeof i.badge)a.html("loading");else{var l=i.badge;a.html('<div id="id_holder" style="display:none;"></div><div class="item_info" style="overflow: hidden;"><div class="header">'+$E.translate("view_specialitem_badge")+": "+l.name+'</div><div class="picture" style="float:right; position: relative; height: 100px; width: 100px;"><img style="max-width: 100%; max-height: 100%;" src="'+l.imageUrl+'"></div><div class="body">'+l.description+"</div>")}else i.type="text",a.html('<div id="id_holder" style="display:none;"></div><div class="header"></div><div class="body"><p class="text" '+$E.translate("view_specialitem_text_defaulttext")+'"></p></div>'),a.find("div.header").append($E.translate("view_specialitem_text")+(e.trim(i.block_title).length?": "+i.block_title:"")),a.find("div.body").append(i.print_text);return a.find(":input[default-text]").focus(function(){e(this).removeClass("default-text"),e(this).attr("default-text")==e(this).val()&&e(this).val("")}).blur(function(){e.trim(e(this).val())||(e(this).addClass("default-text"),e(this).val(e(this).attr("default-text")))}).blur(),a.find("div#id_holder").append(i.id),"new"==t?"item"!=i.type&&"badge"!=i.type&&e('<a class="edit" title="Edit"><span>Edit</span></a>').prependTo(a).click(c):a.append('<a class="unsaved" title="This block was not saved"><span>Unsaved</span></a>'),e('<a class="delete" title="'+$E.translate("delete")+'"><span>'+$E.translate("delete")+"</span></a>").prependTo(a).click(o),a.find(":input").change(function(){a.data("portfolio").text=e(this).val()}),s(),1==i.unshared&&(a.find("div.item_info").addClass("unshared_block"),$item_header=a.find("div.header").html(),a.find("div.header").html($item_header+'<span class="unshared_message">Unshared</span>')),a}function o(){e(this).parents(".item").remove(),n(),s()}function r(){var t=e("form#view_edit_form").serializeArray();t.push({name:"ajax",value:1}),e.ajax({url:document.location.href,type:"POST",data:t,success:function(t){var i=JSON.parse(t);e("form :input[name=blocks]").val(i.blocks),exaportViewEdit.resetViewContent()}})}function c(){var t=e(this).parent().find("#id_holder").html();lastclicked=e(this).parent(),e.ajax({url:M.cfg.wwwroot+"/blocks/exaport/blocks.json.php",type:"POST",data:{item_id:t,action:"edit",viewid:e("form :input[name=viewid]").val(),"text[itemid]":e("form :input[name=draft_itemid]").val(),sesskey:e("form :input[name=sesskey]").val()},success:function(e){var t=JSON.parse(e);m(t.modalTitle,t.html)}})}function m(t,i){p?(p.setTitle(t),p.setBody(i),p.show()):a.create(v).done(function(a){p=a,p.setTitle(t),p.setBody(i),p.show(),p.getRoot().on(d.hidden,function(){console.log("modal is hidden"),p.setBody(""),newItem&&e(newItem).remove()})})}function h(){var t="",i=e("#exaport-view-mod");i.find(":input[name=externaccess]").is(":checked")?(t+=$E.translate("externalaccess")+" ",e("#externaccess-settings").show()):e("#externaccess-settings").hide(),i.find(":input[name=internaccess]").is(":checked")?(e("#internaccess-settings").show(),e("#internaccess-groups").hide(),t&&(t+=" "+$E.translate("viewand")+" "),t+=$E.translate("internalaccess")+": ",1==i.find(":input[name=shareall]:checked").val()?(t+=$E.translate("internalaccessall"),e("#internaccess-users").hide(),e("#internaccess-groups").hide()):2==i.find(":input[name=shareall]:checked").val()?(t+=$E.translate("internalaccessgroups"),e("#internaccess-users").hide(),e("#internaccess-groups").show(),ExabisEportfolio.load_grouplist("views_mod")):(t+=$E.translate("internalaccessusers"),e("#internaccess-groups").hide(),e("#internaccess-users").show(),ExabisEportfolio.load_userlist("views_mod"))):e("#internaccess-settings").hide(),i.find(":input[name=sharedemails]").is(":checked")?(t&&(t+=" "+$E.translate("viewand")+" "),t+=$E.translate("emailaccess")+" ",e("#emailaccess-settings").show()):e("#emailaccess-settings").hide(),t||(t=$E.translate("view_sharing_noaccess")),e("#view-share-text").html(t)}var p,v={title:"test title",body:"",footer:""},f=function(){var t={resetViewContent:function(){var t=e("form :input[name=blocks]").val();t&&(t=e.parseJSON(t)),t||(t=[{type:"headline"}]);var i=e(".portfolioDesignBlocks");i.empty(),e.each(t,function(){l("new",this).appendTo(this.positionx&&i[this.positionx-1]?i[this.positionx-1]:i[0])}),n(),s()},initAddItems:function(t){e("#add-items-list .add-item").click(function(t){var i=e(this).find("input");e(t.target).is(":input")||i.prop("checked",!i.prop("checked")),i.prop("checked")?e(this).addClass("checked"):e(this).removeClass("checked")})},addPersonalInfo:function(t){if(this.checkFields()){-1!=t&&(newItem=lastclicked);var i={};if(i.type="personal_information",i.id=t,i.block_title=e("#block_title").val(),"checked"==e("#firstname").attr("checked")&&(i.firstname=e("#firstname").val()),"checked"==e("#lastname").attr("checked")&&(i.lastname=e("#lastname").val()),i.picture=e("form input[name=picture]:checked").val(),i.email=e("form input[name=email]:checked").val(),i.text=e("#id_block_intro").val(),e(".mceEditor iframe").length){var a=e(".mceEditor iframe"),d=e("#tinymce",a.contents());d.length&&(i.text=d.html())}newItem.data("portfolio",i),l("update",e(newItem)),p.hide(),newItem=null,r()}},addHeadline:function(t){this.checkFields()&&(-1!=t&&(newItem=lastclicked),data={},data.text=e("#headline").val(),data.type="headline",data.id=t,newItem.data("portfolio",data),l("update",e(newItem)),newItem=null,p.hide(),r())},addText:function(t){if(console.log(M.core_filepicker),this.checkFields()){if(-1!=t&&(newItem=lastclicked),data={},data.type="text",data.id=t,data.block_title=e("#block_title").val(),data.text=e("#id_block_text").val(),e(".mceEditor iframe").length){var i=e(".mceEditor iframe"),a=e("#tinymce",i.contents());a.length&&(data.text=a.html())}newItem.data("portfolio",data),l("update",e(newItem)),p.hide(),newItem=null,r()}},addItem:function(t){if(this.checkFields()){-1!=t&&(newItem=lastclicked);var i=0;e("#blockform input.add-item-checkbox:checked").each(function(){if(i+=1,i>1){var t=e(newItem).clone();newItem.after(t),newItem=t}data={},data.type="item",data.itemid=e(this).val(),newItem.data("portfolio",data),l("update",e(newItem))}),p.hide(),newItem=null,r()}},addMedia:function(t){this.checkFields()&&(-1!=t&&(newItem=lastclicked),data={},data.block_title=e("#block_title").val(),data.type="media",data.contentmedia=e("#block_media").val(),data.width=e("#block_width").val(),data.height=e("#block_height").val(),data.create_as_note=e("input[name=create_as_note]:checked").length?1:0,data.id=t,newItem.data("portfolio",data),l("update",e(newItem)),p.hide(),newItem=null,r())},addBadge:function(t){if(this.checkFields()){-1!=t&&(newItem=lastclicked);var i=0;e('#blockform input[name="add_badges[]"]:checked').each(function(){if(i+=1,i>1){var t=e(newItem).clone();newItem.after(t),newItem=t}data={},data.type="badge",data.itemid=e(this).val(),newItem.data("portfolio",data),l("update",e(newItem))}),p.hide(),newItem=null,r()}},checkFields:function(){var t=!0;return e("#blockform .not-empty-check").each(function(){var i=e(this).attr("for"),a=e("#blockform").find('input[name="'+i+'"]');return 0==a.length?void e(this).hide():a.val().length?void e(this).hide():(e(this).show(),a.focus(),t=!1,!1)}),t},filterItemsByTag:function(){console.log("1111"),e("#filterByTitle").val(""),e("div.add-item-category").hide(),e("div.add-item").show(),e("div.add-item-sub").show(),e("tr.sharedArtefacts").show();var t=e(".tagfilter").val();""!=t?e("div.add-item").each(function(){var i=e(this).data("tags");void 0!==i?-1==i.indexOf(t)&&e(this).hide():e(this).hide()}):e("div.add-item-category, div.add-item-sub").show(),e("div.add-item-sub").each(function(){0==e(this).find("div.add-item:visible").length&&e(this).hide()}),e("div.add-item:visible").each(function(){var t=e(this).data("category");e('div.add-item-category[data-category="'+t+'"]').show()}),0==e('div.add-item[data-category="sharedFromUser"]:visible').length&&e("tr.sharedArtefacts").hide()},filterItemsByTitle:function(){e(".tagfilter").length&&(e(".tagfilter")[0].selectedIndex=0);var t=e("#blockform #filterByTitle").val().toLowerCase();e("div.add-item-category").hide(),e("div.add-item").show(),e("div.add-item-sub").show(),e("tr.sharedArtefacts").show(),""!=t?e("div.add-item:visible").each(function(){var i=e(this).text();i.toLowerCase().indexOf(t)>-1?e(this).show():e(this).hide()}):e("div.add-item-category, div.add-item-sub").show(),e("div.add-item-sub").each(function(){0==e(this).find("div.add-item:visible").length&&e(this).hide()}),e("div.add-item:visible").each(function(){var t=e(this).data("category");e('div.add-item-category[data-category="'+t+'"]').show()}),0==e('div.add-item[data-category="sharedFromUser"]:visible').length&&e("tr.sharedArtefacts").hide()},clearItemFilters:function(){e(".tagfilter").length&&(e(".tagfilter")[0].selectedIndex=0),e("#blockform #filterByTitle").val(""),exaportViewEdit.filterItemsByTitle()},cancelAddEdit:function(){p.hide(),s()}};return t},u=function(){exaportViewEdit=f(),exaportViewEdit.resetViewContent(),e(".portfolioDesignBlocks").sortable({beforeStop:function(e,t){newItem=t.item},receive:function(t,i){var a=e(i.item[0]).closest("ul").prop("className");-1==a.search("portfolioDesignBlocks")&&(e.ajax({url:M.cfg.wwwroot+"/blocks/exaport/blocks.json.php",type:"POST",data:{type_block:i.item.attr("block-type"),action:"add",viewid:e("form :input[name=viewid]").val(),"text[itemid]":e("form :input[name=draft_itemid]").val(),sesskey:e("form :input[name=sesskey]").val()},success:function(t){var i=JSON.parse(t);m(i.modalTitle,i.html),e("#temp_javascript").remove();var a=document.createElement("script");e(a).attr("id","temp_javascript"),console.log(i.script),a.textContent=i.script,document.body.appendChild(a),e("body").on("change keydown paste input","#filterByTitle",exaportViewEdit.filterItemsByTitle)}}),s())},update:function(e,t){s()},handle:".header",placeholder:"block-placeholder",forcePlaceholderSize:!0,connectWith:[".portfolioDesignBlocks"]}),e(".portfolioOptions").sortable({connectWith:[".portfolioDesignBlocks"],placeholder:"block-placeholder",forcePlaceholderSize:!0,stop:function(e,t){resetElements()}}),e(".portfolioElement").draggable({connectToSortable:".portfolioDesignBlocks",placeholder:".block-placeholder",forcePlaceholderSize:!0,helper:"clone",stop:function(e,t){}})};return{initialise:function(t){console.log("exaport AMD loaded"),u(),e(".view-sharing input[type=checkbox], .view-sharing input[type=radio]").click(h),h()}}});